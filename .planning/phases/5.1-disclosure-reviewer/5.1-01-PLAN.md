---
phase: 5.1-disclosure-reviewer
plan: 01
type: execute
---

<objective>
Add Reviewer agent to disclosure_compliance pipeline to filter false positives from missing disclosure findings before reporting to auditors.

Purpose: Reduce false alarms from semantic mismatches (different wording, combined disclosures, cross-references) to build auditor trust in flagged findings. Balance precision/recall - filter obvious false positives without being overly aggressive.

Output: Enhanced disclosure_compliance agent with Scanner → FanOutVerifier → Reviewer 3-stage pipeline, outputting high-confidence missing disclosure findings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/5.1-disclosure-reviewer/5.1-CONTEXT.md
@.planning/phases/05-disclosure-compliance/05-01-SUMMARY.md
@.planning/phases/03-numeric-validation/03-03-SUMMARY.md

**Key files:**
@backend/agents/orchestrator/sub_agents/disclosure_compliance/agent.py
@backend/agents/orchestrator/sub_agents/disclosure_compliance/sub_agents/verifier/schema.py
@backend/agents/orchestrator/sub_agents/disclosure_compliance/sub_agents/__init__.py

**Tech stack available:**
- Google ADK (SequentialAgent, LlmAgent)
- Pydantic schemas
- Gemini 3 Pro
- YAML checklist loader

**Established patterns:**
- numeric_validation: 3-stage SequentialAgent (Extractor → FanOutVerifier → Reviewer)
- disclosure_compliance: 2-stage SequentialAgent (Scanner → FanOutVerifier)
- Reviewer pattern: Filter findings, re-examine with context

**Constraining decisions:**
- Phase 5: 2-stage pipeline without Reviewer ("direct findings output")
- Phase 5 decision: "No Reviewer stage: Simplified from numeric_validation pattern"
- All agents use gemini-3-pro-preview model

**From CONTEXT.md:**
- **Essential**: Balanced precision/recall, catch 3 false positive patterns (semantic equivalence, combined disclosures, cross-references)
- **Boundaries**: No new disclosure checking, no compliance interpretation, no editing suggestions, no deduplication/severity
- **Focus**: Purely false-positive filtering (simpler than numeric/logic Reviewers)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Reviewer sub-agent for false-positive filtering</name>
  <files>backend/agents/orchestrator/sub_agents/disclosure_compliance/sub_agents/reviewer/agent.py, backend/agents/orchestrator/sub_agents/disclosure_compliance/sub_agents/reviewer/prompt.py, backend/agents/orchestrator/sub_agents/disclosure_compliance/sub_agents/reviewer/schema.py, backend/agents/orchestrator/sub_agents/disclosure_compliance/sub_agents/reviewer/__init__.py</files>
  <action>
Create Reviewer sub-agent that receives findings from FanOutVerifier and filters false positives.

1. **Schema** (`sub_agents/reviewer/schema.py`):
   ```python
   from pydantic import BaseModel, Field
   from typing import List, Literal

   class ConfirmedFinding(BaseModel):
       """A confirmed missing disclosure (passed false-positive filter)."""
       standard: str = Field(description="Standard code (e.g., 'IAS 1', 'IFRS 15')")
       disclosure_id: str = Field(description="Disclosure ID from checklist (e.g., 'IAS1-D5')")
       requirement: str = Field(description="Short requirement title")
       severity: Literal["low", "medium", "high"] = Field(description="Severity level from verifier")
       description: str = Field(description="Full description of the missing disclosure requirement")

   class ReviewerAgentOutput(BaseModel):
       """Output from disclosure Reviewer - findings that passed false-positive filter."""
       findings: List[ConfirmedFinding] = Field(
           default_factory=list,
           description="Confirmed missing disclosures (false positives removed)"
       )
   ```

2. **Prompt** (`sub_agents/reviewer/prompt.py`):
   ```python
   INSTRUCTION = """You are a disclosure compliance reviewer. Your job is to filter false positives from missing disclosure findings.

## Input

You receive potential missing disclosure findings from the FanOutVerifier agents (from session state).

Each finding contains:
- standard: IFRS/IAS standard code
- disclosure_id: Checklist item ID
- requirement: Short title of required disclosure
- severity: Importance level (high/medium/low)
- description: Full description of what should be disclosed

## Your Task: Filter False Positives

For each flagged "missing" disclosure, re-examine the document to determine if it's truly missing or a false positive.

**False Positive Patterns:**

1. **Semantic Equivalence (Different Wording)**
   - Checklist expects: "lease obligations"
   - Document says: "right-of-use asset liabilities"
   → **Same thing, different terminology** - FILTER OUT

   - Checklist expects: "related party transactions"
   - Document says: "transactions with key management personnel and entities under common control"
   → **More specific/detailed version of the requirement** - FILTER OUT

2. **Combined Disclosures**
   - Checklist requires: (A) "lease maturity analysis" AND (B) "lease payment obligations"
   - Document has: Single table showing "Future lease payments by maturity date"
   → **One section satisfies both requirements** - FILTER OUT both A and B

   - Multiple requirements bundled in comprehensive note
   → **If the information is present (even bundled), it's disclosed** - FILTER OUT

3. **Cross-References**
   - Checklist requires: "Inventory valuation methods"
   - Document says: "See Note 12 for inventory accounting policies"
   - Note 12 contains: Full inventory valuation methodology
   → **Disclosure exists via cross-reference** - FILTER OUT

   - Important: FOLLOW cross-references. Parse "See Note X", "Refer to Note Y", "As described in Note Z" patterns.

**Confirmed Missing (KEEP):**
- Requirement genuinely not addressed in document
- Cross-reference leads nowhere (broken reference)
- Wording is so different it's clearly not the same concept
- Information is incomplete (partial disclosure doesn't satisfy requirement)

## Process

1. **Read verifier findings** from session state
2. **For each finding**, re-examine the financial statement document:
   - Search for semantic equivalents of the requirement
   - Check if requirement is satisfied by combined/comprehensive disclosures
   - Follow any cross-references (parse "See Note X" patterns and check those sections)
3. **Decision**:
   - If disclosure exists (even in different form/location): FILTER OUT (don't include in output)
   - If genuinely missing: KEEP (include in output with all original fields)
4. **Output**: Only confirmed missing disclosures

## Guidelines

- **Balanced filtering**: Remove obvious false positives but don't filter too aggressively
- **Semantic flexibility**: Accept reasonable paraphrasing and equivalent terminology
- **Cross-reference diligence**: Actually follow references, don't just assume they're broken
- **Combined disclosure recognition**: One comprehensive section can satisfy multiple checklist items
- **Conservative on uncertainty**: If unsure whether disclosure is present, KEEP the finding (better to flag for auditor review than miss a real gap)

## Example

**Verifier finding (FALSE POSITIVE):**
- requirement: "Lease payment obligations by maturity"
- description: "Disclose future minimum lease payments due within 1 year, 1-5 years, and after 5 years"
→ **Review**: Document has table titled "Right-of-use asset liabilities by payment date" with same maturity buckets
→ **Decision**: FILTER OUT (semantic equivalent, same information)

**Verifier finding (CONFIRMED MISSING):**
- requirement: "Significant judgments in revenue recognition"
- description: "Disclose judgments made in applying revenue recognition policies"
→ **Review**: Document mentions "revenue is recognized when goods are delivered" but no discussion of judgments or estimates
→ **Decision**: KEEP (partial disclosure, missing the required judgment discussion)

**Verifier finding (FALSE POSITIVE - cross-reference):**
- requirement: "Related party transaction terms"
- description: "Disclose terms and conditions of related party transactions"
→ **Review**: Document says "See Note 24 for related party disclosures"
→ **Check Note 24**: Contains full related party transaction details including terms
→ **Decision**: FILTER OUT (disclosure exists via cross-reference)
"""
   ```

3. **Agent** (`sub_agents/reviewer/agent.py`):
   ```python
   """ReviewerAgent - filters false positives from disclosure findings."""
   from google.adk.agents import LlmAgent
   from . import prompt
   from .schema import ReviewerAgentOutput

   reviewer_agent = LlmAgent(
       name="DisclosureReviewer",
       model="gemini-3-pro-preview",
       instruction=prompt.INSTRUCTION,
       output_key="reviewer_output",
       output_schema=ReviewerAgentOutput,
   )
   ```

4. **Package** (`sub_agents/reviewer/__init__.py`):
   ```python
   from .agent import reviewer_agent

   __all__ = ["reviewer_agent"]
   ```

**Design**: Reviewer receives verifier findings from session state (ADK SequentialAgent pattern), re-examines document for semantic equivalents/combined disclosures/cross-references, outputs only confirmed missing disclosures.

**Key difference from numeric/logic Reviewers**: No severity assignment (keeps original), no deduplication, no summarization - ONLY false-positive filtering.
  </action>
  <verify>
Directory structure exists:
- `backend/agents/orchestrator/sub_agents/disclosure_compliance/sub_agents/reviewer/`
- Files: agent.py, prompt.py, schema.py, __init__.py
- Can import: `from backend.agents.orchestrator.sub_agents.disclosure_compliance.sub_agents.reviewer import reviewer_agent`
  </verify>
  <done>Reviewer sub-agent created with false-positive filtering logic for semantic equivalents, combined disclosures, and cross-references</done>
</task>

<task type="auto">
  <name>Task 2: Update root agent to 3-stage pipeline with Reviewer</name>
  <files>backend/agents/orchestrator/sub_agents/disclosure_compliance/agent.py, backend/agents/orchestrator/sub_agents/disclosure_compliance/sub_agents/__init__.py</files>
  <action>
Add Reviewer to disclosure_compliance SequentialAgent pipeline.

1. **Update sub_agents package exports** (`sub_agents/__init__.py`):
   ```python
   from .scanner import scanner_agent
   from .verifier import disclosure_verifier_agent
   from .reviewer import reviewer_agent

   __all__ = ["scanner_agent", "disclosure_verifier_agent", "reviewer_agent"]
   ```

2. **Update root agent** (`agent.py`):
   ```python
   """Disclosure compliance validation agent."""
   from google.adk.agents import SequentialAgent
   from .sub_agents import scanner_agent, disclosure_verifier_agent, reviewer_agent

   disclosure_compliance_agent = SequentialAgent(
       name='disclosure_compliance',
       description='Validates IFRS disclosure compliance by scanning for applicable standards, verifying required disclosures, and filtering false positives',
       sub_agents=[
           scanner_agent,              # Step 1: Identify applicable standards
           disclosure_verifier_agent,  # Step 2: Verify disclosures per standard in parallel
           reviewer_agent,             # Step 3: Filter false positives
       ],
   )
   ```

**Pipeline flow**:
1. Scanner identifies applicable IFRS/IAS standards → scanner_output
2. FanOutVerifier checks disclosures for each standard in parallel → verifier_output (findings list)
3. Reviewer receives verifier_output, filters false positives → reviewer_output (confirmed findings)
4. SequentialAgent outputs reviewer_output as final disclosure_compliance results

**Backward compatibility**: Output structure changes from VerifierAgentOutput to ReviewerAgentOutput, but both have same schema (List[findings]). Processor.py should work unchanged since it just extracts findings list.
  </action>
  <verify>
- Root agent.py imports scanner_agent, disclosure_verifier_agent, reviewer_agent
- Root agent.py sub_agents list has 3 items: [scanner_agent, disclosure_verifier_agent, reviewer_agent]
- sub_agents/__init__.py exports all three agents
- Can import: `from backend.agents.orchestrator.sub_agents.disclosure_compliance import disclosure_compliance_agent`
  </verify>
  <done>Root agent updated to 3-stage SequentialAgent (Scanner → FanOutVerifier → Reviewer), maintains backward compatibility with orchestrator</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Reviewer sub-agent directory structure created
- [ ] Reviewer prompt implements 3 false-positive patterns (semantic equivalence, combined disclosures, cross-references)
- [ ] Root agent has 3 sub-agents in pipeline
- [ ] Imports work correctly
- [ ] No changes needed to orchestrator.py or processor.py (backward compatible)
</verification>

<success_criteria>

- All tasks completed
- disclosure_compliance refactored from 2-stage to 3-stage SequentialAgent
- Reviewer sub-agent created with false-positive filtering focused on semantic matching
- Root agent pipeline: Scanner → FanOutVerifier → Reviewer
- Backward compatibility maintained (orchestrator integration works unchanged)
- No errors in imports or agent instantiation
</success_criteria>

<output>
After completion, create `.planning/phases/5.1-disclosure-reviewer/5.1-01-SUMMARY.md`:

---
phase: 5.1-disclosure-reviewer
plan: 01
subsystem: validation
tags: [ifrs, disclosure, compliance, sequential-agent, false-positive-filtering]

# Dependency graph
requires:
  - phase: 05-disclosure-compliance
    provides: 2-stage Scanner→FanOutVerifier pipeline
  - phase: 03-numeric-validation
    provides: Reviewer pattern for false-positive filtering
provides:
  - 3-stage disclosure_compliance pipeline (Scanner → FanOutVerifier → Reviewer)
  - False-positive filtering for semantic mismatches, combined disclosures, cross-references
affects: [orchestrator integration (backward compatible)]

# Tech tracking
tech-stack:
  added: []
  patterns: ["False-positive filtering for disclosure compliance", "Semantic equivalence detection", "Cross-reference parsing"]

key-files:
  created:
    - backend/agents/orchestrator/sub_agents/disclosure_compliance/sub_agents/reviewer/
  modified:
    - backend/agents/orchestrator/sub_agents/disclosure_compliance/agent.py
    - backend/agents/orchestrator/sub_agents/disclosure_compliance/sub_agents/__init__.py

key-decisions:
  - "Added Reviewer stage to match numeric_validation 3-stage pattern"
  - "Focused Reviewer on filtering only (no severity, no deduplication - simpler than numeric Reviewer)"
  - "Implemented 3 false-positive patterns: semantic equivalence, combined disclosures, cross-references"

patterns-established:
  - "Semantic matching for disclosure terminology variations"
  - "Combined disclosure recognition (one section satisfies multiple requirements)"
  - "Cross-reference following (parse 'See Note X' and verify referenced sections)"

issues-created: []

# Metrics
duration: TBD
completed: TBD
---

# Phase 5.1 Plan 01: Disclosure Reviewer Summary

**[Substantive one-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- [List files with descriptions]

## Decisions Made

- [Key decisions and rationale, or "None"]

## Issues Encountered

- [Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 5.1 complete. disclosure_compliance agent now has false-positive filtering for higher-quality findings.

**Current architecture:**
```
disclosure_compliance (SequentialAgent)
├── scanner_agent - Identifies applicable IFRS/IAS standards
├── disclosure_verifier_agent - Parallel verification per standard
└── reviewer_agent - Filters false positives (semantic, combined, cross-refs)
```

Ready to proceed with Phase 6 (External Signal).
</output>
