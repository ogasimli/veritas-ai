---
phase: 03-numeric-validation
plan: 03-02
type: execute
domain: agents
---

<objective>
Create the Validator agent with BuiltInCodeExecutor that performs deterministic math verification on FSLIs.

Purpose: Core numeric validation - verify that financial calculations are mathematically correct.
Output: Validator agent that generates and executes Python code to verify FSLI math.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-numeric-validation/DISCOVERY.md
@.planning/phases/03-numeric-validation/03-01-PLAN.md
@backend/app/services/agents/planner.py

**Tech stack available:**
- google-adk with BuiltInCodeExecutor
- Planner agent outputs FSLIs to session.state['fslis']

**Critical constraint from DISCOVERY.md:**
- BuiltInCodeExecutor can ONLY be used by itself in an agent
- Cannot combine with other tools
- Sandbox has numpy, pandas available

**Pattern:**
```python
from google.adk.code_executors import BuiltInCodeExecutor
from .schema import ValidatorAgentOutput
from . import prompt

validator_agent = LlmAgent(
    name="ValidatorAgent",
    model="gemini-3-pro-preview",
    code_executor=BuiltInCodeExecutor(),
    instruction=prompt.INSTRUCTION,
    output_key="validator_agent_output",
    output_schema=ValidatorAgentOutput
)
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Validator agent with code_executor</name>
  <files>backend/agents/numeric_validation/sub_agents/validator/agent.py, backend/agents/numeric_validation/sub_agents/validator/prompt.py, backend/agents/numeric_validation/sub_agents/validator/__init__.py</files>
  <action>
1. Create `prompt.py` with `INSTRUCTION` constant:
   - You are a financial math validator.
   - You receive FSLIs from {planner_agent_output} (JSON array of financial line items).
   - Perform TWO types of validation:
     1. **Sum verification**: For each FSLI with multiple values, write Python code to:
        - Extract the values.
        - Verify any apparent calculations (e.g., sum, percentage, YoY change).
        - Check if component parts sum to totals.
     2. **Cross-table consistency**: If the same FSLI name appears in multiple tables, compare values and flag discrepancies.
   - Use pandas for table operations if needed.
   - Output JSON array of validation results.
2. Create `agent.py` with `validator_agent`:
   - use `LlmAgent`, `BuiltInCodeExecutor`, `ValidatorAgentOutput`.
   - `output_key="validator_agent_output"`.
3. Create `__init__.py` to export `validator_agent`.

Avoid: Don't add other tools. Keep code_executor alone.
  </action>
  <verify>python -c "from agents.numeric_validation.sub_agents.validator import validator_agent; print(validator_agent.name)" shows ValidatorAgent</verify>
  <done>Validator agent created with structured package pattern</done>
</task>

<task type="auto">
  <name>Task 2: Define local schema for Validator results</name>
  <files>backend/agents/numeric_validation/sub_agents/validator/schema.py</files>
  <action>
1. Create `schema.py` in the validator directory:
   - Define `ValidationResult` (fsli_name, check_type, expected, actual, is_valid, discrepancy, code_used, table_refs).
   - Define `ValidatorAgentOutput` containing a list of `ValidationResult`.
  </action>
  <verify>python -c "from agents.numeric_validation.sub_agents.validator.schema import ValidatorAgentOutput; print('schema ok')"</verify>
  <done>Local schema defined in agent package</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] backend/agents/numeric_validation/sub_agents/validator/agent.py exists
- [ ] backend/agents/numeric_validation/sub_agents/validator/schema.py exists
- [ ] Validator agent reads from {planner_agent_output}
- [ ] Validator agent writes to output_key="validator_agent_output"
- [ ] All imports work
- [ ] **Unit Tests**: `export PYTHONPATH=$(pwd) && ./.venv/bin/pytest agents/numeric_validation/tests` passes
- [ ] **ADK Run**: `export PYTHONPATH=$(pwd) && ./.venv/bin/adk run agents/numeric_validation` works as expected
</verification>

<success_criteria>
- All tasks completed
- Validator agent configured with code_executor (no other tools)
- Validation result schema ready for downstream processing
- Planner â†’ Validator state flow established via {planner_agent_output}
</success_criteria>

<output>
After completion, create `.planning/phases/03-numeric-validation/03-02-SUMMARY.md`:

# Phase 03 Plan 02: Validator Agent Summary

**[Substantive one-liner about what was built]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `backend/agents/numeric_validation/sub_agents/validator/agent.py` - Description
- `backend/agents/numeric_validation/sub_agents/validator/prompt.py` - Description
- `backend/agents/numeric_validation/sub_agents/validator/schema.py` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-03-PLAN.md (Manager agent and pipeline orchestration)
</output>
