---
phase: 03-numeric-validation
plan: 03-03
type: execute
domain: agents
---

<objective>
Create the Manager agent for aggregation, build the SequentialAgent pipeline, and integrate into document processing flow.

Purpose: Complete the numeric validation pipeline and connect it to the application.
Output: Working end-to-end pipeline that processes documents and produces findings.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-numeric-validation/DISCOVERY.md
@.planning/phases/03-numeric-validation/03-01-PLAN.md
@.planning/phases/03-numeric-validation/03-02-PLAN.md
@backend/app/models/finding.py
@backend/app/models/job.py
@backend/app/services/agents/planner.py
@backend/app/services/agents/validator.py

**Tech stack available:**
- SequentialAgent for pipeline orchestration
- Planner (output_key=fslis) → Validator (output_key=validation_results) → Manager
- Finding model with category, severity, description, source_refs, reasoning, agent_id

**Pattern from RESEARCH.md:**
```python
from google.adk.agents import SequentialAgent
from .sub_agents.planner import planner_agent
from .sub_agents.validator import validator_agent
from .sub_agents.manager import manager_agent

root_agent = SequentialAgent(
    name="numeric_validation",
    sub_agents=[planner_agent, validator_agent, manager_agent]
)
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Manager agent and local schema</name>
  <files>backend/agents/numeric_validation/sub_agents/manager/agent.py, backend/agents/numeric_validation/sub_agents/manager/prompt.py, backend/agents/numeric_validation/sub_agents/manager/schema.py</files>
  <action>
1. Create `schema.py`: Define `FindingItem` and `ManagerAgentAgentOutput`.
2. Create `prompt.py`: `INSTRUCTION` to filter `validator_agent_output` and format findings.
3. Create `agent.py`: `manager_agent` using `gemini-3-pro-preview`.
  </action>
  <verify>python -c "from agents.numeric_validation.sub_agents.manager import manager_agent; print(manager_agent.name)"</verify>
  <done>Manager agent and local schema created</done>
</task>

<task type="auto">
  <name>Task 2: Assemble SequentialAgent pipeline</name>
  <files>backend/agents/numeric_validation/agent.py</files>
  <action>
1. Update `agent.py` in numeric_validation root:
   - Import all three sub-agents.
   - Define `root_agent = SequentialAgent(sub_agents=[planner, validator, manager])`.
  </action>
  <verify>python -c "from agents.numeric_validation.agent import root_agent; print(len(root_agent.sub_agents))" shows 3</verify>
  <done>Sequential pipeline assembled in root_agent</done>
</task>

<task type="auto">
  <name>Task 3: Integrate pipeline into document processing service</name>
  <files>backend/app/services/processor.py, backend/app/api/routes/documents.py</files>
  <action>
1. Create backend/app/services/processor.py:
   - Import NumericValidationPipeline, async SQLAlchemy session, models
   - Create class DocumentProcessor:
     * __init__(self, db: AsyncSession)
     * async method process_document(self, job_id: UUID, extracted_text: str):
       - Update job status to "processing"
       - Import `root_agent` from `agents.numeric_validation`
       - Create `InMemoryRunner(agent=root_agent)`
       - For each finding in results:
         * Create Finding model instance
         * Set job_id, category, severity, description, source_refs, reasoning
         * Set agent_id="NumericValidationPipeline"
         * Add to session
       - Commit findings to database
       - Update job status to "completed"
       - Handle exceptions: update job status to "failed", set error_message
2. Update backend/app/api/routes/documents.py:
   - Import DocumentProcessor
   - In the background task (from Phase 2), after extraction:
     * Call DocumentProcessor.process_document(job_id, extracted_text)
   - This chains: upload → extract → validate (all in background)
3. Export DocumentProcessor from services/__init__.py

Avoid: Don't add WebSocket updates yet (Phase 7). Don't add parallel agent execution yet (single pipeline for now).
  </action>
  <verify>Backend starts without errors: cd backend && python -c "from app.services.processor import DocumentProcessor"</verify>
  <done>Document upload triggers extraction → validation pipeline → findings saved to DB</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] backend/agents/numeric_validation/sub_agents/manager/agent.py exists
- [ ] backend/agents/numeric_validation/agent.py exists with root_agent
- [ ] backend/app/services/processor.py integrated with root_agent
- [ ] Pipeline chain: Planner (planner_agent_output) → Validator (validator_agent_output) → Manager (manager_agent_output)
- [ ] Document upload triggers full processing pipeline
- [ ] Findings saved to database with correct schema
- [ ] **Unit Tests**: `export PYTHONPATH=$(pwd) && ./.venv/bin/pytest agents/numeric_validation/tests` passes
- [ ] **ADK Run**: `export PYTHONPATH=$(pwd) && ./.venv/bin/adk run agents/numeric_validation` works as expected
</verification>

<success_criteria>
- All tasks completed
- End-to-end flow: upload → extract → planner → validator → manager → findings in DB
- Job status updated throughout processing
- Phase 3 complete: Numeric Validation pipeline operational
</success_criteria>

<output>
After completion, create `.planning/phases/03-numeric-validation/03-03-SUMMARY.md`:

# Phase 03 Plan 03: Manager Agent + Pipeline Integration Summary

**[Substantive one-liner about what was built]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]
- [Key outcome 3]

## Files Created/Modified

- `backend/agents/numeric_validation/sub_agents/manager/agent.py` - Agent logic
- `backend/agents/numeric_validation/agent.py` - Sequential pipeline root
- `backend/app/services/processor.py` - DB integration
- `backend/app/api/routes/documents.py` - Trigger update

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 3 complete, ready for Phase 4: Logic Consistency
</output>
