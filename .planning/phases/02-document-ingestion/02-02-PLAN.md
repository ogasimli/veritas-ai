---
type: plan
phase: 02-document-ingestion
plan: 02-02
domain: document-ingestion
---

# Plan 02-02: Extractor Agent

Implement the logic to extract structured text and tables from `.docx` files in order, converting them into Markdown for LLM consumption.

## Objective
Convert uploaded `.docx` files into a structured Markdown format that preserves the document's flow and table structures.

## Execution Context
- **Tech available**: `python-docx`, FastAPI `BackgroundTasks`.
- **Patterns**: Iterative element parsing (paragraphs and tables) from `document.element.body`.
- **Decisions**: Extraction will run as a background task immediately after upload.

## Tasks

<task name="implement_extractor_service" type="auto">
Create the extraction logic using `python-docx`.
<files>
- backend/app/services/extractor.py
</files>
<action>
1. Load document using `Document(file_path)`.
2. Iterate through body elements.
3. For paragraphs: extract text and maintain headers if possible.
4. For tables: convert to Markdown table format.
5. Join all parts into a single Markdown string.
</action>
<verify>
Unit test or script can convert a sample docx to markdown.
</verify>
</task>

<task name="integrate_background_tasks" type="auto">
Update the upload endpoint to trigger extraction in the background.
<files>
- backend/app/api/routes/documents.py
</files>
<action>
1. Add `BackgroundTasks` to the upload endpoint.
2. Define a task `process_document` that calls `ExtractorService`.
3. Update `Document.extracted_text`.
4. Update `Job.status` to "completed" (or "processing" if more steps follow in later phases).
</action>
<verify>
After upload, the `Document` record in DB eventually contains the extracted text.
</verify>
</task>

<task name="add_unit_tests" type="tdd">
Add tests for the extractor to ensure table integrity.
<files>
- backend/tests/test_extractor.py
</files>
<action>
Create a mock or small docx file and verify table to markdown conversion.
</action>
<verify>
`pytest backend/tests/test_extractor.py` passes.
</verify>
</task>

## Success Criteria
- [ ] Document content is extracted in its original order.
- [ ] Tables are correctly formatted as Markdown.
- [ ] Extraction runs asynchronously after upload.
- [ ] Database is updated with the extracted content.
