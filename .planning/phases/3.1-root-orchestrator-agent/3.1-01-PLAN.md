---
phase: 3.1-root-orchestrator-agent
plan: 01
type: execute
---

<objective>
Create root orchestrator agent that coordinates all validation agents in parallel using Google ADK's ParallelAgent pattern. Restructure existing numeric_validation agent to be a sub-agent under the orchestrator.

Purpose: Enable parallel execution of multiple validation pipelines (numeric, logic, disclosure, external) with a single root agent that aggregates findings.
Output: Root orchestrator agent with numeric_validation as first sub-agent, integrated into DocumentProcessor.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-numeric-validation/03-03-SUMMARY.md

**Tech stack available:**
- Google ADK (SequentialAgent, ParallelAgent patterns)
- Gemini 3 Pro with code_executor tool
- FastAPI + async SQLAlchemy
- Existing numeric_validation pipeline (Extractor → FanOutVerifier → Reviewer)

**Established patterns:**
- Sequential agent pipeline (Phase 3: numeric_validation)
- Parallel fan-out pattern (Phase 3: FanOutVerifier)
- InMemoryRunner for agent execution (Phase 3: DocumentProcessor)

**Key files:**
@backend/agents/numeric_validation/agent.py
@backend/app/services/processor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create root orchestrator agent structure</name>
  <files>backend/agents/orchestrator/__init__.py, backend/agents/orchestrator/agent.py, backend/agents/orchestrator/sub_agents/__init__.py</files>
  <action>
Create new orchestrator agent package at backend/agents/orchestrator/:
- agent.py: Define root ParallelAgent named 'audit_orchestrator' with description 'Coordinates parallel validation agents for financial statement audit'
- Initially configure with empty sub_agents list (will be populated after moving numeric_validation)
- __init__.py: Export orchestrator_agent
- sub_agents/__init__.py: Create empty package (will contain numeric_validation and future agents)

Use ParallelAgent from google.adk.agents. Follow same structure as existing numeric_validation/agent.py but with ParallelAgent instead of SequentialAgent.
  </action>
  <verify>ls backend/agents/orchestrator/ shows agent.py, __init__.py, sub_agents/__init__.py files exist</verify>
  <done>Orchestrator package created with ParallelAgent structure ready to accept sub-agents</done>
</task>

<task type="auto">
  <name>Task 2: Move numeric_validation to orchestrator sub-agent</name>
  <files>backend/agents/orchestrator/sub_agents/numeric_validation/</files>
  <action>
Move backend/agents/numeric_validation/ to backend/agents/orchestrator/sub_agents/numeric_validation/:
- Use git mv to preserve history: `git mv backend/agents/numeric_validation backend/agents/orchestrator/sub_agents/numeric_validation`
- Update backend/agents/orchestrator/sub_agents/__init__.py to export numeric_validation agent: `from .numeric_validation.agent import root_agent as numeric_validation_agent`
- Update backend/agents/orchestrator/agent.py to import and include numeric_validation in sub_agents list
- Update backend/agents/__init__.py if it references numeric_validation (change import path)

Do NOT modify the internal structure of numeric_validation - it should remain unchanged with its 3-stage pipeline (Extractor → FanOutVerifier → Reviewer).
  </action>
  <verify>git status shows rename, ls backend/agents/orchestrator/sub_agents/numeric_validation/ shows all original files, python -c "from backend.agents.orchestrator.agent import orchestrator_agent; print(orchestrator_agent.sub_agents)" shows numeric_validation in list</verify>
  <done>numeric_validation successfully moved under orchestrator as first sub-agent, imports work correctly</done>
</task>

<task type="auto">
  <name>Task 3: Update DocumentProcessor to use orchestrator</name>
  <files>backend/app/services/processor.py</files>
  <action>
Update DocumentProcessor to use orchestrator instead of numeric_validation directly:
- Change import: `from agents.orchestrator.agent import orchestrator_agent` (instead of numeric_validation.agent)
- Update line 30: `runner = InMemoryRunner(agent=orchestrator_agent, app_name="veritas-ai")`
- Update findings extraction logic to handle orchestrator output structure:
  - Orchestrator runs sub-agents in parallel and aggregates their session states
  - Extract findings from numeric_validation sub-agent output: `final_state.get("numeric_validation", {}).get("reviewer_output", {}).get("findings", [])`
- Keep agent_id as "numeric_validation" for now (since only numeric findings exist)
- Add comment explaining future agents will be added to orchestrator

The orchestrator will eventually coordinate 4 agents in parallel, but for now it only runs numeric_validation.
  </action>
  <verify>grep orchestrator_agent backend/app/services/processor.py shows updated import, python -m pytest backend/agents/orchestrator/tests/ passes (if tests exist), backend service starts without errors</verify>
  <done>DocumentProcessor uses orchestrator agent, numeric findings still saved correctly, service runs without errors</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `ls backend/agents/orchestrator/` shows proper structure
- [ ] `git status` shows numeric_validation moved (not copied)
- [ ] Import works: `python -c "from backend.agents.orchestrator.agent import orchestrator_agent"`
- [ ] DocumentProcessor imports and uses orchestrator_agent
- [ ] No broken imports in codebase
</verification>

<success_criteria>

- Root orchestrator agent created with ParallelAgent pattern
- numeric_validation moved to orchestrator/sub_agents/ preserving git history
- DocumentProcessor updated to use orchestrator
- All imports working correctly
- Code structure ready for adding logic/disclosure/external agents as future sub-agents
</success_criteria>

<output>
After completion, create `.planning/phases/3.1-root-orchestrator-agent/3.1-01-SUMMARY.md`:

# Phase 3.1 Plan 01: Root Orchestrator Agent Summary

**[One-liner summary of what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 3.1 complete. Root orchestrator structure ready for Phase 4-6 agents to be added as sub-agents.
</output>
