---
phase: 04-logic-consistency
plan: 04-01
type: execute
domain: agents
---

<objective>
Create the Logic Consistency agent that detects semantically unreasonable claims in financial statements, even when numbers are mathematically correct. Add it as a sub-agent to the orchestrator for parallel execution.

Purpose: Catch business logic errors that pure math validation misses (e.g., "revenue up 500% but headcount down 80%").
Output: LogicConsistencyAgent integrated into orchestrator agent as second parallel sub-agent.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-numeric-validation/03-03-SUMMARY.md
@.planning/phases/3.1-root-orchestrator-agent/3.1-01-SUMMARY.md
@backend/agents/orchestrator/agent.py
@backend/agents/orchestrator/sub_agents/numeric_validation/agent.py
@backend/app/services/processor.py
@backend/app/models/finding.py

**Tech stack available (from Phase 3 & 3.1):**
- LlmAgent with instruction, output_key
- gemini-3-pro-preview model
- Finding model with category, severity, description, source_refs, reasoning
- ParallelAgent orchestrator pattern (Phase 3.1)

**Architecture established (Phase 3.1):**
```
orchestrator_agent (ParallelAgent)
├── numeric_validation_agent (SequentialAgent) - Phase 3
└── logic_consistency_agent (NEW) - Phase 4
```

**Pattern to follow:**
Create logic_consistency agent under `backend/agents/orchestrator/sub_agents/logic_consistency/`, similar to numeric_validation structure. Use LlmAgent for the agent implementation (simpler than SequentialAgent since no pipeline needed).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create logic_consistency agent package</name>
  <files>backend/agents/orchestrator/sub_agents/logic_consistency/__init__.py, backend/agents/orchestrator/sub_agents/logic_consistency/agent.py, backend/agents/orchestrator/sub_agents/logic_consistency/prompt.py, backend/agents/orchestrator/sub_agents/logic_consistency/schema.py</files>
  <action>
Create logic_consistency agent under orchestrator/sub_agents/:

1. Create `schema.py`: Define `LogicFinding` (with fsli_name, claim, contradiction, severity, reasoning) and `LogicConsistencyOutput` (with findings list)
2. Create `prompt.py`: Instructions for detecting semantic contradictions - claims that are logically impossible or inconsistent even if numerically correct
3. Create `agent.py`: Define `logic_consistency_agent` using LlmAgent (name="logic_consistency", model="gemini-3-pro-preview", instruction from prompt, output_key="logic_consistency_output", output_schema=LogicConsistencyOutput)
4. Create `__init__.py`: Export logic_consistency_agent

Follow the same package structure as numeric_validation but simpler (no sub-agents needed - single LlmAgent is sufficient).
  </action>
  <verify>python -c "from agents.orchestrator.sub_agents.logic_consistency import logic_consistency_agent; print(logic_consistency_agent.name)"</verify>
  <done>logic_consistency agent package created under orchestrator/sub_agents/</done>
</task>

<task type="auto">
  <name>Task 2: Add logic_consistency to orchestrator</name>
  <files>backend/agents/orchestrator/sub_agents/__init__.py, backend/agents/orchestrator/agent.py</files>
  <action>
Integrate logic_consistency into the orchestrator:

1. Update `orchestrator/sub_agents/__init__.py`: Import logic_consistency_agent and add to __all__
2. Update `orchestrator/agent.py`: Import logic_consistency_agent and add to orchestrator_agent.sub_agents list after numeric_validation_agent

The orchestrator will now run both agents in parallel. No changes needed to DocumentProcessor - it already uses orchestrator_agent.
  </action>
  <verify>python -c "from agents.orchestrator.agent import orchestrator_agent; print([a.name for a in orchestrator_agent.sub_agents])"</verify>
  <done>logic_consistency integrated as second sub-agent in orchestrator</done>
</task>

<task type="auto">
  <name>Task 3: Update DocumentProcessor findings extraction</name>
  <files>backend/app/services/processor.py</files>
  <action>
Update DocumentProcessor to extract and save logic consistency findings:

1. After extracting numeric_validation findings, extract logic findings: `logic_state = final_state.get("logic_consistency", {}); logic_output = logic_state.get("logic_consistency_output", {}); logic_findings = logic_output.get("findings", [])`
2. Save logic findings to database with category="logic" (similar to numeric findings loop)
3. Update comment to reflect both agents running in parallel via orchestrator
  </action>
  <verify>grep "logic_consistency" backend/app/services/processor.py shows extraction logic</verify>
  <done>DocumentProcessor extracts and saves findings from both numeric and logic agents</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] backend/agents/orchestrator/sub_agents/logic_consistency/agent.py exists
- [ ] backend/agents/orchestrator/sub_agents/logic_consistency/schema.py exists
- [ ] backend/agents/orchestrator/sub_agents/logic_consistency/prompt.py exists
- [ ] logic_consistency_agent added to orchestrator.sub_agents list
- [ ] Orchestrator has 2 sub-agents: numeric_validation and logic_consistency
- [ ] DocumentProcessor extracts findings from both agents
- [ ] Findings saved with category="logic"
- [ ] All imports work without errors
</verification>

<success_criteria>
- All tasks completed
- Logic consistency agent created as LlmAgent
- Integrated into orchestrator as second parallel sub-agent
- DocumentProcessor extracts and saves findings from both numeric and logic agents
- Architecture: orchestrator runs numeric + logic agents in parallel
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-logic-consistency/04-01-SUMMARY.md`:

# Phase 04 Plan 01: Logic Consistency Agent Summary

**Logic consistency agent integrated as second sub-agent in orchestrator for parallel semantic validation alongside numeric checks.**

## Accomplishments

- Created logic_consistency agent package under orchestrator/sub_agents/
- Integrated logic_consistency as second sub-agent in orchestrator (runs in parallel with numeric_validation)
- Updated DocumentProcessor to extract and save findings from both agents
- Established pattern for adding future agents (disclosure_compliance, external_signal)

## Files Created/Modified

**Created:**
- `backend/agents/orchestrator/sub_agents/logic_consistency/__init__.py` - Package exports
- `backend/agents/orchestrator/sub_agents/logic_consistency/agent.py` - LlmAgent definition
- `backend/agents/orchestrator/sub_agents/logic_consistency/prompt.py` - Semantic contradiction detection instructions
- `backend/agents/orchestrator/sub_agents/logic_consistency/schema.py` - LogicFinding and LogicConsistencyOutput schemas

**Modified:**
- `backend/agents/orchestrator/sub_agents/__init__.py` - Import logic_consistency_agent
- `backend/agents/orchestrator/agent.py` - Add logic_consistency to sub_agents list
- `backend/app/services/processor.py` - Extract and save logic findings

## Decisions Made

- Used simple LlmAgent instead of SequentialAgent (no pipeline needed for logic checks)
- Followed orchestrator pattern from Phase 3.1 for consistency
- Category="logic" for findings to distinguish from numeric findings

## Issues Encountered

None - followed established orchestrator pattern from Phase 3.1

## Next Step

Phase 4 complete. Ready for Phase 5: Disclosure Compliance (third sub-agent)
</output>
