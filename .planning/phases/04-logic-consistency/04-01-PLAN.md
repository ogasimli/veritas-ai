---
phase: 04-logic-consistency
plan: 04-01
type: execute
domain: agents
---

<objective>
Create the Logic Consistency agent that detects semantically unreasonable claims in financial statements, even when numbers are mathematically correct.

Purpose: Catch business logic errors that pure math validation misses (e.g., "revenue up 500% but headcount down 80%").
Output: Working LogicConsistencyAgent integrated into document processing pipeline.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-numeric-validation/DISCOVERY.md
@.planning/phases/03-numeric-validation/03-03-PLAN.md
@backend/app/services/agents/pipeline.py
@backend/app/services/processor.py
@backend/app/models/finding.py

**Tech stack available (from Phase 3):**
- LlmAgent with instruction, output_key
- gemini-3-pro-preview model
- Finding model with category, severity, description, source_refs, reasoning

**Pattern reuse:**
- Structured agent package: `backend/agents/logic_consistency/`
- Root agent redirects to sub-agents.
- Sub-agent `analyzer` defines logic.
- Local schema `LogicConsistencyAgentOutput`.
```python
# backend/agents/logic_consistency/sub_agents/analyzer/agent.py
logic_analyzer_agent = LlmAgent(
    name="LogicAnalyzerAgent",
    model="gemini-3-pro-preview",
    instruction=prompt.INSTRUCTION,
    output_key="logic_analyzer_agent_output",
    output_schema=LogicConsistencyAgentOutput
)
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LogicConsistency agent package</name>
  <files>backend/agents/logic_consistency/sub_agents/analyzer/agent.py, backend/agents/logic_consistency/sub_agents/analyzer/prompt.py, backend/agents/logic_consistency/sub_agents/analyzer/schema.py, backend/agents/logic_consistency/agent.py</files>
  <action>
1. Create `schema.py`: Define `LogicFinding` and `LogicConsistencyAgentOutput`.
2. Create `prompt.py`: Detailed instructions for semantic contradiction detection.
3. Create `agent.py` (sub-agent): Define `logic_analyzer_agent`.
4. Create `agent.py` (root): Define `root_agent` wrapping the analyzer.
  </action>
  <verify>python -c "from agents.logic_consistency.agent import root_agent; print(root_agent.name)"</verify>
  <done>Logic Consistency agent package created with structured pattern</done>
</task>

<task type="auto">
  <name>Task 2: Integrate into DocumentProcessor</name>
  <files>backend/app/services/processor.py</files>
  <action>
1. Update `DocumentProcessor.process_document`:
   - Import `root_agent` from `agents.logic_consistency`.
   - Run it after numeric validation.
   - Save findings to DB.
  </action>
  <verify>python -c "from app.services.processor import DocumentProcessor; print('processor ok')"</verify>
  <done>Logic consistency integrated into the processing flow</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] backend/agents/logic_consistency/sub_agents/analyzer/agent.py exists
- [ ] backend/agents/logic_consistency/agent.py exists
- [ ] LogicConsistencyAgent uses reasoning chain approach
- [ ] DocumentProcessor runs both numeric and logic pipelines
- [ ] Findings saved with category="logic"
- [ ] All imports work without errors
- [ ] **Unit Tests**: `export PYTHONPATH=$(pwd) && ./.venv/bin/pytest agents/logic_consistency/tests` passes (to be created)
- [ ] **ADK Run**: `export PYTHONPATH=$(pwd) && ./.venv/bin/adk run agents/logic_consistency` works as expected
</verification>

<success_criteria>
- All tasks completed
- Logic agent detects semantic inconsistencies
- Findings include reasoning_chain for audit trail
- Document processing: upload → extract → numeric validation → logic consistency → findings in DB
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-logic-consistency/04-01-SUMMARY.md`:

# Phase 04 Plan 01: Logic Consistency Agent Summary

**[Substantive one-liner about what was built]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `backend/agents/logic_consistency/sub_agents/analyzer/agent.py` - Analyzer logic
- `backend/agents/logic_consistency/agent.py` - Logic package root
- `backend/app/services/processor.py` - Integration

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 4 complete, ready for Phase 5: Disclosure Compliance
</output>
