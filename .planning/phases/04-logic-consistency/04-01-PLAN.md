---
phase: 04-logic-consistency
plan: 04-01
type: execute
domain: agents
---

<objective>
Create the Logic Consistency agent that detects semantically unreasonable claims in financial statements, even when numbers are mathematically correct.

Purpose: Catch business logic errors that pure math validation misses (e.g., "revenue up 500% but headcount down 80%").
Output: Working LogicConsistencyAgent integrated into document processing pipeline.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-numeric-validation/DISCOVERY.md
@.planning/phases/03-numeric-validation/03-03-PLAN.md
@backend/app/services/agents/pipeline.py
@backend/app/services/processor.py
@backend/app/models/finding.py

**Tech stack available (from Phase 3):**
- LlmAgent with instruction, output_key
- gemini-3-pro model
- Finding model with category, severity, description, source_refs, reasoning

**Pattern reuse:**
- Single LlmAgent (no code_executor needed - reasoning only)
- Output structured findings like NumericValidation
- Integrate into DocumentProcessor alongside numeric pipeline

**Discovery level: 0 (Skip)**
- Reuses established ADK patterns
- No new dependencies
- Pure prompt engineering
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LogicConsistencyAgent with reasoning chains</name>
  <files>backend/app/services/agents/logic_consistency.py</files>
  <action>
1. Create logic_consistency.py with LogicConsistencyAgent:
   - Import LlmAgent from google.adk.agents
   - Define LOGIC_CONSISTENCY_INSTRUCTION constant with detailed reasoning prompt:
     * You are a financial statement logic analyzer
     * Given extracted document text, identify claims that are semantically unreasonable
     * Types of logic issues to detect:
       - Contradictory trends (revenue up but all business metrics down)
       - Implausible magnitudes (500% growth in mature market)
       - Impossible values (negative cash, >100% margins)
       - Inconsistent narratives (expansion claims but shrinking operations)
       - Missing context red flags (large one-time gains without explanation)
     * For each issue found:
       - Quote the specific claim(s)
       - Explain why it's logically inconsistent
       - Provide reasoning chain (step-by-step logic)
       - Assign severity: high (material misrepresentation risk), medium (needs explanation), low (unusual but possible)
     * Output JSON array: [{claim, issue_type, reasoning_chain, severity, source_ref}]
   - Create function create_logic_consistency_agent() -> LlmAgent:
     * name="LogicConsistencyAgent"
     * model="gemini-3-pro"
     * instruction=LOGIC_CONSISTENCY_INSTRUCTION
     * output_key="logic_issues"
2. Export create_logic_consistency_agent from agents/__init__.py

Avoid: Don't add code_executor - this is pure reasoning. Don't try to verify math (that's numeric validation's job). Focus on semantic/business logic only.
  </action>
  <verify>python -c "from app.services.agents.logic_consistency import create_logic_consistency_agent; a = create_logic_consistency_agent(); print(a.name, a.output_key)" shows LogicConsistencyAgent logic_issues</verify>
  <done>LogicConsistencyAgent created with reasoning chain instruction, outputs logic_issues</done>
</task>

<task type="auto">
  <name>Task 2: Create LogicConsistencyPipeline and integrate into processor</name>
  <files>backend/app/services/agents/logic_pipeline.py, backend/app/services/processor.py</files>
  <action>
1. Create logic_pipeline.py with LogicConsistencyPipeline:
   - Import InMemoryRunner from google.adk.runners
   - Import create_logic_consistency_agent
   - Create class LogicConsistencyPipeline:
     * __init__(self): creates logic consistency agent
     * async method run(self, extracted_text: str) -> list[dict]:
       - Creates InMemoryRunner with the agent
       - Runs with user_message=extracted_text
       - Extracts issues from session.state['logic_issues']
       - Returns parsed issues list
2. Update backend/app/services/processor.py:
   - Import LogicConsistencyPipeline
   - In process_document method, after numeric validation:
     * Create LogicConsistencyPipeline instance
     * Run with extracted_text
     * For each issue in results:
       - Create Finding with category="logic"
       - Set severity, description (from reasoning_chain), source_refs
       - Set agent_id="LogicConsistencyAgent"
       - Add to session
     * Commit logic findings alongside numeric findings
3. Export LogicConsistencyPipeline from agents/__init__.py

Avoid: Don't run in parallel with numeric validation yet (sequential is fine for v1). Don't add WebSocket updates (Phase 7).
  </action>
  <verify>python -c "from app.services.agents.logic_pipeline import LogicConsistencyPipeline; from app.services.processor import DocumentProcessor; print('imports ok')"</verify>
  <done>Logic pipeline created and integrated into document processing flow</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] backend/app/services/agents/logic_consistency.py exists
- [ ] backend/app/services/agents/logic_pipeline.py exists
- [ ] LogicConsistencyAgent uses reasoning chain approach
- [ ] DocumentProcessor runs both numeric and logic pipelines
- [ ] Findings saved with category="logic"
- [ ] All imports work without errors
</verification>

<success_criteria>
- All tasks completed
- Logic agent detects semantic inconsistencies
- Findings include reasoning_chain for audit trail
- Document processing: upload → extract → numeric validation → logic consistency → findings in DB
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-logic-consistency/04-01-SUMMARY.md`:

# Phase 04 Plan 01: Logic Consistency Agent Summary

**[Substantive one-liner about what was built]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `backend/app/services/agents/logic_consistency.py` - Description
- `backend/app/services/agents/logic_pipeline.py` - Description
- `backend/app/services/processor.py` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 4 complete, ready for Phase 5: Disclosure Compliance
</output>
